
ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 1





       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



	Source File:	pratica3_4.asm
	Object File:	pratica3_4.hex
	List File:	pratica3_4.lst



 Line  I  Addr  Code            Source

    1:				; Praticas 3 e 4: Contador de segundos e de pulsos
    2:				; Programador: Francisco Edno
    3:				;
    4:				; A partir de uma chave alavanca o contexto de execucao do microcontrolador
    5:				; e selecionado. No contexto 0, e realizada a contagem de segundos. No contexto
    6:				; 1 uma contagem de pulsos. Para cada contexto e utilizado um banco de
    7:				; registradores diferentes, de modo que o estado do contexto anterior
    8:				; seja salvo na memoria. A ideia de mudanca de contexto foi obtida a partir
    9:				; do livro do Scott Mackenzie. O objetivo desse projeto e puramente
   10:				; educacional.
   11:
   12:				; Push button: p2.0, Shift Register: p2.1, p2.2 e p2.3, chave de contexto: p2.4
   13:				;
   14:				; ----------------------------------------------------------
   15:				; Mapa de registradores
   16:				; ----------------------------------------------------------
   17:				; R0: Contagem binaria
   18:				; R1: Parte decimal
   19:				; R2: Unidade
   20:				;
   21:				; Banco 0: Contador de segundos
   22:				; Banco 1: Contador de pulsos
   23:				; ----------------------------------------------------------
   24:
   25:
   26:				; **********************************************************
   27:				; Equates
   28:				; **********************************************************
   29:
   30:		B      00A0	BTN		equ		p2.0

   31:
   32:		B      00A1	SHD			equ		p2.1				; Fluxo de dados no registra
				dor
   33:		B      00A2	SHCK		equ		p2.2				; Clock do registrador
   34:		B      00A3	SHLTCH		equ		p2.3				; Latch do registrador
   35:
   36:		B      00A4	CONTSW		equ		p2.4				; Chave seletora de contexto
   37:
   38:				; **********************************************************
   39:				; Configuracoes iniciais
   40:				; **********************************************************
   41:

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 2



 Line  I  Addr  Code            Source

   42:				; O 8052 divide os enderecos do SFRs com 128 bytes extras de memoria ram.
   43:				; Essa memoria extra so pode ser acessada por enderecamento indireto,
   44:				; por isso a pilha pode ser inicializada nessa regiao
   45:
   46:	  0000	75 81 7F				mov			sp, #7fh					; In
				icializa a pilha na regiao de memoria extra do 8052
   47:
   48:				; Inicializa os registradores r0, r1 e r2 dos bancos 0 e 1 com #0
   49:
   50:							; Banco 0
   51:	  0003	75 00 00				mov		00h, #0
   52:	  0006	75 01 00				mov		01h, #0
   53:	  0009	75 02 00				mov		02h, #0
   54:
   55:							; Banco 1
   56:	  000C	75 08 00				mov		08h, #0
   57:	  000F	75 09 00				mov		09h, #0
   58:	  0012	75 10 00				mov		10h, #0
   59:
   60:				; **********************************************************
   61:				; Main
   62:				; **********************************************************
   63:
   64:	  0015	11 66					acall		DcdCount
   65:	  0017	11 4F					acall		Display
   66:	  0019			Main:
   67:	  0019	20 A4 0C				jb		CONTSW, Sec
   68:	  001C			Pulse:
   69:	  001C	D2 D3					setb	rs0
   70:	  001E	C2 D4					clr		rs1
   71:
   72:	  0020	11 66					acall	DcdCount
   73:	  0022	11 4F					acall	Display
   74:
   75:	  0024	11 34					acall	PulseCT
   76:	  0026	01 32					ajmp		Exit
   77:	  0028			Sec:
   78:	  0028	C2 D3					clr		rs0
   79:	  002A	C2 D4					clr		rs1
   80:
   81:	  002C	11 66					acall	DcdCount
   82:	  002E	11 4F					acall	Display
   83:
   84:	  0030	11 47					acall	SecCT
   85:
   86:	  0032	01 19		Exit:		ajmp	Main
   87:
   88:				; **********************************************************
   89:				; Sub-Rotinas
   90:				; **********************************************************
   91:
   92:				; ----------------------------------------------------------
   93:				; PulseCT
   94:				; ----------------------------------------------------------
   95:				; Contexto de contagem de pulsos
   96:				; ----------------------------------------------------------

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 3



 Line  I  Addr  Code            Source

   97:	  0034			PulseCT:
   98:	  0034	30 A0 FD				jnb		BTN, $				; Verifico se o botao foi ap
				ertado
   99:	  0037	20 A0 FD				jb		BTN, $				; Verifico se o botao foi li
				berado para contar um pulso
  100:
  101:	  003A	E5 9D					mov		a, not 98			; Limite da contagem de puls
				os
  102:	  003C	28					add		a, r0				; se r0 conter um numero > 9
				8, a carry vai ser setada
  103:
  104:	  003D	50 02					jnc		Inrement			; Se !(r>98), incremente. El
				se, pule
  105:	  003F	01 42					ajmp	Decode
  106:	  0041	08		Inrement:	inc		r0
  107:	  0042			Decode:
  108:	  0042	11 66					acall	DcdCount
  109:	  0044	11 4F					acall	Display
  110:
  111:
  112:	  0046	22					ret
  113:
  114:				; ----------------------------------------------------------
  115:				; SecCT
  116:				; ----------------------------------------------------------
  117:				; Contexto de contagem de segundos
  118:				; ----------------------------------------------------------
  119:	  0047			SecCT:
  120:	  0047	11 66					acall	DcdCount
  121:	  0049	11 4F					acall	Display
  122:							; Fazer a verificacao se r0 = 59
  123:	  004B	11 83					acall	Delay
  124:	  004D	08					inc		r0
  125:
  126:	  004E	22					ret
  127:
  128:				; ----------------------------------------------------------
  129:				; Display
  130:				; ----------------------------------------------------------
  131:				; Imprime os valores dos registradores r1 e r2 nos displays
  132:				; Basicamente, envio bit a bit do acumulador pelo SHD. A cada
  133:				; envio dou um pulso de clock.
  134:				; ----------------------------------------------------------
  135:	  004F			Display:
  136:	  004F	C2 A3					clr		SHLTCH					; Desabilito a saida
				 do shift
  137:
  138:	  0051	EA					mov		a, r2					; Envio primeiro a u
				nidade
  139:	  0052	11 5A					acall	SHSend
  140:
  141:	  0054	E9					mov		a, r1					; Envio depois a dez
				ena
  142:	  0055	11 5A					acall	SHSend
  143:
  144:	  0057	D2 A3					setb	SHLTCH					; travo a saida do shift

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 4



 Line  I  Addr  Code            Source

  145:
  146:	  0059	22					ret
  147:
  148:				; ----------------------------------------------------------
  149:				; SHSend
  150:				; ----------------------------------------------------------
  151:				; Envio serial do acumulador para shift register
  152:				; ----------------------------------------------------------
  153:	  005A			SHSend:
  154:	  005A	7B 08					mov		r3, #8					; Contador
  155:	  005C	A2 E7		Again:		mov		c, acc.7
  156:	  005E	92 A1					mov		SHD, c					; envia a carry para
				 o shift
  157:
  158:	  0060	11 90					acall	CKPulse					; Pulso de clock
  159:
  160:	  0062	23					rl		a
  161:	  0063	DB F7					djnz	r3, Again
  162:
  163:	  0065	22					ret
  164:
  165:				; ----------------------------------------------------------
  166:				; DcdCount
  167:				; ----------------------------------------------------------
  168:				; Decodifica o valor do registrador r0 em BCD e joga os
  169:				; decimal e a unidade nos registradores r1 e r2
  170:				; ----------------------------------------------------------
  171:	  0066			DcdCount:
  172:	  0066	E8					mov		a, r0
  173:	  0067	75 F0 0A				mov		b, #10
  174:
  175:	  006A	84					div		ab
  176:
  177:	  006B	11 74					acall	LKDisp					; Decodifca binario para o d
				isplay e bota no acumulador
  178:	  006D	F9					mov		r1, a					; joga a dezena no r
				1
  179:
  180:	  006E	E5 F0					mov		a, b
  181:	  0070	11 74					acall	LKDisp					; Decodifca binario para o d
				isplay e bota no acumulador
  182:	  0072	FA					mov		r2, a					; joga a unidade no
				r2
  183:
  184:	  0073	22					ret
  185:
  186:				; ----------------------------------------------------------
  187:				; LKDisp
  188:				; ----------------------------------------------------------
  189:				; Look-up table para decodificacao binario -> display
  190:				; ----------------------------------------------------------
  191:	  0074			LKDisp:
  192:	  0074	90 00 79				mov		dptr, #DECODING
  193:	  0077	93					movc	a, @a+dptr
  194:
  195:	  0078	22					ret

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 5



 Line  I  Addr  Code            Source

  196:
  197:	  0079	7E 30 6D 79	DECODING:	db	not 81h, not 0cfh, not 92h, not 86h, not 0cch, not 0a4h, not 0a0h, not 8fh,
	  007D	33 5B 5F 70	not 80h, not 8ch
	  0081	7F 73
  198:
  199:				; ----------------------------------------------------------
  200:				; Delay
  201:				; ----------------------------------------------------------
  202:				; Faz um delay de modo que a rotina de contagem de segundos
  203:				; Feche em aproximadamente 1 segundo
  204:				; ----------------------------------------------------------
  205:	  0083			Delay:
  206:	  0083	7C FF					mov		r4, #255
  207:	  0085	7E FF					mov		r6, #255
  208:	  0087	7D FF		Here:		mov		r5, #255
  209:	  0089	DD FE					djnz	r5, $
  210:	  008B	DE FE					djnz	r6, $
  211:	  008D	DC F8					djnz	r4, Here
  212:	  008F	22					ret
  213:
  214:				; ----------------------------------------------------------
  215:				; CKPulse
  216:				; ----------------------------------------------------------
  217:				; Pulso de clock no registardor de deslocamento
  218:				; ----------------------------------------------------------
  219:	  0090			CKPulse:
  220:	  0090	D2 A2					setb	SHCK
  221:	  0092	C2 A2					clr		SHCK
  222:
  223:	  0094	22					ret
  224:
  225:				; **********************************************************
  226:							end
  227:				; **********************************************************





                     register banks used:  ---

                     no errors




ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 6





	       L I S T   O F   S Y M B O L S
	       =============================


SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
??ASEM_51			  NUMBER    8051
??VERSION			  NUMBER    0130
AC				  BIT	      D6
ACC				  DATA	      E0
AGAIN				  CODE	    005C	 155
B				  DATA	      F0
BTN				  NUMBER    00A0	  30
CKPULSE				  CODE	    0090	 219
CONTSW				  NUMBER    00A4	  36
CY				  BIT	      D7
DCDCOUNT			  CODE	    0066	 171
DECODE				  CODE	    0042	 107
DECODING			  CODE	    0079	 197
DELAY				  CODE	    0083	 205
DISPLAY				  CODE	    004F	 135
DPH				  DATA	      83
DPL				  DATA	      82
EA				  BIT	      AF
ES				  BIT	      AC
ET0				  BIT	      A9
ET1				  BIT	      AB
EX0				  BIT	      A8
EX1				  BIT	      AA
EXIT				  CODE	    0032	  86
EXTI0				  CODE	    0003
EXTI1				  CODE	    0013
F0				  BIT	      D5
HERE				  CODE	    0087	 208
IE				  DATA	      A8
IE0				  BIT	      89
IE1				  BIT	      8B
INREMENT			  CODE	    0041	 106
INT0				  BIT	      B2
INT1				  BIT	      B3
IP				  DATA	      B8
IT0				  BIT	      88
IT1				  BIT	      8A
LKDISP				  CODE	    0074	 191
MAIN				  CODE	    0019	  66
OV				  BIT	      D2
P				  BIT	      D0
P0				  DATA	      80
P1				  DATA	      90
P2				  DATA	      A0
P3				  DATA	      B0
PCON				  DATA	      87
PS				  BIT	      BC
PSW				  DATA	      D0
PT0				  BIT	      B9
PT1				  BIT	      BB

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 7



SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
PULSE				  CODE	    001C	  68
PULSECT				  CODE	    0034	  97
PX0				  BIT	      B8
PX1				  BIT	      BA
RB8				  BIT	      9A
RD				  BIT	      B7
REN				  BIT	      9C
RESET				  CODE	    0000
RI				  BIT	      98
RS0				  BIT	      D3
RS1				  BIT	      D4
RXD				  BIT	      B0
SBUF				  DATA	      99
SCON				  DATA	      98
SEC				  CODE	    0028	  77
SECCT				  CODE	    0047	 119
SHCK				  NUMBER    00A2	  33
SHD				  NUMBER    00A1	  32
SHLTCH				  NUMBER    00A3	  34
SHSEND				  CODE	    005A	 153
SINT				  CODE	    0023
SM0				  BIT	      9F
SM1				  BIT	      9E
SM2				  BIT	      9D
SP				  DATA	      81
T0				  BIT	      B4
T1				  BIT	      B5
TB8				  BIT	      9B
TCON				  DATA	      88
TF0				  BIT	      8D
TF1				  BIT	      8F
TH0				  DATA	      8C
TH1				  DATA	      8D
TI				  BIT	      99
TIMER0				  CODE	    000B
TIMER1				  CODE	    001B
TL0				  DATA	      8A
TL1				  DATA	      8B
TMOD				  DATA	      89
TR0				  BIT	      8C
TR1				  BIT	      8E
TXD				  BIT	      B1
WR				  BIT	      B6
